# 修正作業計画書 - 佐川急便サービス連携変更 (e飛伝Web → スマートクラブ)

| 項目 | 内容 |
|:---|:---|
| **文書番号** | MIG-2024-001 |
| **バージョン** | 1.1 |
| **作成日** | 2024年1月 |
| **最終更新** | 2024年1月 |
| **対象リリース** | v1.1 |

---

## 1. 背景と目的

### 1.1 背景
当初の設計では、佐川急便の「e飛伝Web」を使用した自動発送処理を想定していましたが、同サービスは既に終了しており、現在は「**スマートクラブ (Smart Club for Business)**」が後継のWebサービスとして提供されています。

### 1.2 目的
本計画書は、システムの実装対象を「スマートクラブ」へ変更するための修正手順、スケジュール、およびテスト計画を定義します。

### 1.3 サービス構造の理解

```
┌─────────────────────────────────────────────────────────┐
│           スマートクラブ (Smart Club for Business)        │
│         https://smartclub.sagawa-exp.co.jp/             │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ e飛伝Ⅲ     │  │ 集荷依頼   │  │ 配送状況   │ ... │
│  │ (Web版)    │  │            │  │ 照会       │     │
│  │            │  │            │  │            │     │
│  │ ※送り状   │  │            │  │            │     │
│  │   発行機能 │  │            │  │            │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
```

**重要:** スマートクラブは統合ポータルであり、その中のサービスとして「e飛伝Ⅲ（Web版）」が提供されています。

---

## 2. 変更対象コンポーネント

### 2.1 変更対象ファイル一覧

| # | コンポーネント | ファイルパス | 変更内容 | 優先度 |
|:--|:---|:---|:---|:---|
| 1 | **発送サービス** | `src/services/shipping_service.py` | URL定数、ログイン処理、メニュー遷移、フォーム入力ロジックの刷新 | 高 |
| 2 | **システム仕様書** | `docs/system_specification.md` | 「e飛伝Web」→「スマートクラブ」への記述変更（L597, L625, L854等） | 高 |
| 3 | **選択肢比較表** | `docs/system_options_comparison.md` | 推奨サービス名称と説明の更新（L71-90） | 中 |
| 4 | **ユニットテスト** | `tests/test_shipping_service.py` | モック対象URL・セレクタの更新 | 中 |

### 2.2 変更しないファイル

| ファイル | 理由 |
|:---|:---|
| `src/utils/file_manager.py` | 発送履歴管理ロジックは変更不要 |
| `src/models/item.py` | データモデルは変更不要 |

---

## 3. 修正詳細設計

### 3.1 URL・定数の変更

#### 変更前
```python
# shipping_service.py L24
SAGAWA_EHIDEN_URL = "https://www.e-hiden.net/ehiden/"
```

#### 変更後
```python
# スマートクラブ関連URL
SAGAWA_SMART_CLUB_BASE_URL = "https://www.e-service.sagawa-exp.co.jp/"
SAGAWA_SMART_CLUB_LOGIN_URL = "https://www.e-service.sagawa-exp.co.jp/portal/do/login/show"

# セレクタ定数（法人用）
SELECTOR_BUSINESS_TAB = "label.p-tabs__label--02"
SELECTOR_USER_ID = "#user2"
SELECTOR_PASSWORD = "#pass2"
SELECTOR_LOGIN_BUTTON = "#hojin-login-button"
```

### 3.2 業務フローの変更

#### 変更前 (e飛伝Web) - 3ステップ
```
1. e飛伝Webログインページへアクセス
2. ログインフォーム入力・送信
3. 「送り状発行」メニュークリック → 入力フォーム
```

#### 変更後 (スマートクラブ) - 5ステップ
```
1. スマートクラブログインページへアクセス
   URL: https://smartclub.sagawa-exp.co.jp/

2. ログイン処理
   - ユーザーID入力 (セレクタ: 要調査)
   - パスワード入力 (セレクタ: 要調査)
   - ログインボタンクリック

3. 初回アクセス時の処理（条件付き）
   - サービス利用規約同意画面 → 同意ボタンクリック
   - お知らせポップアップ → 閉じるボタンクリック

4. メニュー選択
   - ダッシュボードから「Webでの送り状発行（e飛伝Ⅲ）」を選択
   - e飛伝Ⅲ画面への遷移を待機

5. 送り状登録フォーム
   - 「新規作成」または「送り状発行」メニュー選択
   - お届け先情報入力
   - 確認 → 登録実行
```

### 3.3 セレクタ仕様（事前調査後に確定）

| 要素 | 推定セレクタ | 確定セレクタ | 備考 |
|:---|:---|:---|:---|
| 法人タブ選択 | - | `label.p-tabs__label--02` | ログイン前に必須 |
| ユーザーID入力 | `#userId`, `input[name="userId"]` | `#user2` | 法人用 |
| パスワード入力 | `#password`, `input[name="password"]` | `#pass2` | 法人用 |
| ログインボタン | `button[type="submit"]`, `.login-btn` | `#hojin-login-button` | 法人用 |
| 規約同意ボタン | `button:has-text("同意")` | `button:has-text("同意"), button:has-text("承諾"), button:has-text("OK")` | 条件付き |
| e飛伝Ⅲメニュー | `a:has-text("e飛伝")`, `.menu-ehiden` | `a:has-text("e飛伝"), a:has-text("送り状")` | ログイン後に調査が必要 |
| 送り状発行メニュー | `a:has-text("送り状発行")` | `a:has-text("送り状発行"), a:has-text("新規作成")` | e飛伝Ⅲ内 |
| 郵便番号入力 | `input[name="postal_code"]` | _要調査_ | e飛伝Ⅲ内 |
| 住所入力 | `input[name="address"]`, `textarea[name="address"]` | _要調査_ | e飛伝Ⅲ内 |
| 氏名入力 | `input[name="name"]` | _要調査_ | e飛伝Ⅲ内 |
| 電話番号入力 | `input[name="tel"]` | _要調査_ | e飛伝Ⅲ内 |
| 品名入力 | `input[name="product_name"]` | _要調査_ | e飛伝Ⅲ内 |
| 確認ボタン | `button:has-text("確認")` | _要調査_ | e飛伝Ⅲ内 |
| 登録ボタン | `button:has-text("登録")` | _要調査_ | e飛伝Ⅲ内 |
| エラーメッセージ | `.error`, `.alert-danger` | `.error, .alert-danger, [class*="error"]` | 汎用 |
| 送り状番号表示 | `.tracking-number`, `.slip-number` | `.tracking-number, .slip-number` | 登録完了後 |

---

## 4. リスクと対策

### 4.1 リスク一覧

| # | リスク | 影響度 | 発生可能性 | 対策 |
|:--|:---|:---|:---|:---|
| R1 | DOM構造が複雑でセレクタ特定が困難 | 高 | 中 | `headless=False`で開発、DevToolsで要素特定 |
| R2 | 初回アクセス時に予期しない画面が表示される | 中 | 高 | 規約同意・ポップアップ処理を実装、タイムアウト設定 |
| R3 | セッションタイムアウトが短い | 中 | 中 | 操作前にログイン状態確認、再ログイン処理を実装 |
| R4 | スマートクラブのUI変更により動作しなくなる | 高 | 低 | セレクタを設定ファイル化し変更容易に |
| R5 | e飛伝Ⅲへの遷移にiframe/新ウィンドウが使用される | 中 | 中 | Playwright のframe/page切り替え処理を実装 |

### 4.2 想定される初回アクセス時の挙動と対応

```python
# 実装例：初回アクセス時の処理
def _handle_first_time_access(page: Page) -> None:
    """初回アクセス時の規約同意・ポップアップ処理"""

    # サービス利用規約同意画面
    agree_button = page.locator('button:has-text("同意"), button:has-text("承諾")')
    if agree_button.count() > 0:
        agree_button.first.click()
        page.wait_for_load_state("networkidle")

    # お知らせポップアップ
    close_button = page.locator('.popup-close, button:has-text("閉じる")')
    if close_button.count() > 0:
        close_button.first.click()
        page.wait_for_timeout(500)
```

---

## 5. 作業スケジュール

### 5.1 フェーズ構成

| フェーズ | 内容 | 予定時間 |
|:---|:---|:---|
| **Phase 0** | 事前調査 | 60分 |
| **Phase 1** | 実装 | 120分 |
| **Phase 2** | テスト | 60分 |
| **Phase 3** | ドキュメント更新 | 30分 |
| **合計** | | **270分（4.5時間）** |

### 5.2 詳細スケジュール

#### Phase 0: 事前調査（60分）

| # | 作業内容 | 予定時間 | 成果物 |
|:--|:---|:---|:---|
| 0-1 | スマートクラブに手動ログイン、画面構造の把握 | 15分 | 画面フローメモ |
| 0-2 | DevToolsでセレクタ調査・記録 | 30分 | セレクタ一覧（上記表を埋める） |
| 0-3 | iframe/新ウィンドウの有無確認 | 10分 | 技術メモ |
| 0-4 | 初回アクセス時の挙動確認 | 5分 | 対応方針決定 |

#### Phase 1: 実装（120分）

| # | 作業内容 | 予定時間 | 対象ファイル |
|:--|:---|:---|:---|
| 1-1 | URL定数の更新 | 5分 | `shipping_service.py` |
| 1-2 | ログイン処理の実装 | 30分 | `shipping_service.py` |
| 1-3 | 初回アクセス処理の実装 | 15分 | `shipping_service.py` |
| 1-4 | メニュー遷移処理の実装 | 20分 | `shipping_service.py` |
| 1-5 | 送り状入力フォーム処理の実装 | 40分 | `shipping_service.py` |
| 1-6 | エラーハンドリングの調整 | 10分 | `shipping_service.py` |

#### Phase 2: テスト（60分）

| # | 作業内容 | 予定時間 | テスト種別 |
|:--|:---|:---|:---|
| 2-1 | ログイン成功テスト | 10分 | E2E |
| 2-2 | 送り状登録正常系テスト | 15分 | E2E |
| 2-3 | エラーケーステスト | 15分 | E2E |
| 2-4 | 重複防止機能テスト | 10分 | E2E |
| 2-5 | ユニットテスト修正・実行 | 10分 | Unit |

#### Phase 3: ドキュメント更新（30分）

| # | 作業内容 | 予定時間 | 対象ファイル |
|:--|:---|:---|:---|
| 3-1 | システム仕様書の更新 | 15分 | `system_specification.md` |
| 3-2 | 選択肢比較表の更新 | 10分 | `system_options_comparison.md` |
| 3-3 | 本計画書のセレクタ確定版更新 | 5分 | `migration_plan_smart_club.md` |

---

## 6. テスト計画

### 6.1 テストケース一覧

#### 正常系テスト

| # | テストケース | 前提条件 | 期待結果 |
|:--|:---|:---|:---|
| T01 | ログイン成功 | 有効な認証情報 | ダッシュボード画面が表示される |
| T02 | e飛伝Ⅲメニュー遷移 | ログイン済み | e飛伝Ⅲ画面が表示される |
| T03 | 送り状登録成功 | 有効な配送先情報 | 登録完了、送り状番号が発行される |
| T04 | 履歴への記録 | 登録成功後 | `shipped_ids.json`に記録される |
| T05 | 重複防止動作 | 同一IDで再実行 | スキップされ、重複登録されない |

#### 異常系テスト

| # | テストケース | 入力条件 | 期待結果 |
|:--|:---|:---|:---|
| T06 | ログイン失敗 | 無効な認証情報 | 例外発生、適切なエラーメッセージ |
| T07 | 未ログイン状態での操作 | セッション切れ | 例外発生、「ログインしていません」エラー |
| T08 | 必須項目欠落（氏名なし） | 氏名が空 | 例外発生、処理中断 |
| T09 | 必須項目欠落（住所なし） | 住所が空 | 例外発生、処理中断 |
| T10 | サーバーエラー発生 | 500エラー | 例外発生、リトライ後エラー |

#### 境界値テスト

| # | テストケース | 入力条件 | 期待結果 |
|:--|:---|:---|:---|
| T11 | 長い住所 | 100文字以上の住所 | 正常登録または適切な切り詰め |
| T12 | 特殊文字を含む氏名 | 「髙橋」等の旧字体 | 正常登録 |
| T13 | ハイフン付き郵便番号 | `123-4567` | ハイフン除去後正常登録 |

### 6.2 テスト実行コマンド

```bash
# ユニットテスト実行
uv run pytest tests/test_shipping_service.py -v

# E2Eテスト実行（headlessモードOFF）
uv run pytest tests/e2e/test_shipping_e2e.py -v --headed

# カバレッジ計測
uv run pytest tests/test_shipping_service.py --cov=src/services/shipping_service --cov-report=html
```

---

## 7. 完了条件

### 7.1 必須条件（Must）

| # | 条件 | 確認方法 |
|:--|:---|:---|
| C01 | `shipping_service.py`がスマートクラブURLを使用している | コードレビュー |
| C02 | ログイン→e飛伝Ⅲ遷移→送り状登録の一連フローが動作する | E2Eテスト T01-T04 |
| C03 | 重複防止機能が正常動作する | E2Eテスト T05 |
| C04 | エラー時に即時停止し、適切なメッセージが表示される | E2Eテスト T06-T10 |
| C05 | `system_specification.md`の記述が「スマートクラブ」に統一されている | ドキュメントレビュー |
| C06 | `system_options_comparison.md`の記述が更新されている | ドキュメントレビュー |
| C07 | ユニットテストが全て通過する | `uv run pytest` |

### 7.2 推奨条件（Should）

| # | 条件 | 確認方法 |
|:--|:---|:---|
| C08 | セレクタが設定ファイルまたは定数として管理されている | コードレビュー |
| C09 | 本計画書のセレクタ一覧が確定値で埋められている | ドキュメントレビュー |
| C10 | テストカバレッジが80%以上 | カバレッジレポート |

---

## 8. ロールバック計画

### 8.1 ロールバック判断基準

以下のいずれかに該当する場合、ロールバックを検討する：

1. スマートクラブへのログインが安定しない（成功率90%未満）
2. 送り状登録の成功率が95%未満
3. 予期しないエラーが頻発し、業務に支障が出る

### 8.2 ロールバック手順

```bash
# 1. 変更前のコミットを確認
git log --oneline -10

# 2. 変更前のコミットにリバート
git revert <commit-hash>

# 3. テスト実行
uv run pytest

# 4. 動作確認後、コミット
git commit -m "Revert: スマートクラブ対応を一時ロールバック"
```

### 8.3 代替案

ロールバック後、以下の代替案を検討する：

1. **手動運用への一時切り替え**: 発送登録のみ手動で行い、他機能は自動継続
2. **部分的な自動化**: 落札情報取得までは自動、送り状登録は手動
3. **佐川急便への問い合わせ**: API提供の有無、推奨連携方法の確認

---

## 9. 関連ドキュメント

| ドキュメント | パス | 関連セクション |
|:---|:---|:---|
| システム詳細仕様書 | `docs/system_specification.md` | Section 2.6, 7, 11 |
| 選択肢比較表 | `docs/system_options_comparison.md` | Section 3 |
| E2Eテストガイド | `docs/e2e_testing_guide.md` | 発送フローテスト |
| ユーザーマニュアル | `docs/user_manual.md` | 発送操作手順 |

---

## 10. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|:---|:---|:---|:---|
| 1.0 | 2024/01/XX | 初版作成 | - |
| 1.1 | 2024/01/XX | レビュー指摘反映：テスト計画追加、スケジュール見直し、ロールバック計画追加 | - |
